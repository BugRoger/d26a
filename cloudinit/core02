#cloud-config

hostname: core02

ssh-authorized-keys:
  - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAvFapuevZeHFpFn438XMjvEQYd0wt7+tzUdAkMiSd007Tx1h79Xm9ZziDDUe4W6meinVOq93MAS/ER27hoVWGo2H/vn/Cz5M8xr2j5rQODnrF3RmfrJTbZAWaDN0JTq2lFjmCHhZJNhr+VQP1uw4z2ofMBP6MLybnLmm9ukzxFYZqCCyfEEUTCMA9SWywtTpGQp8VLM4INCxzBSCuyt3SO6PBvJSo4HoKg/sLvmRwpCVZth48PI0EUbJ72wp88Cw3bv8CLce2TOkLMwkE6NRN55w2aOyqP1G3vixHa6YcVaLlkQhJoJsBwE3rX5603y2KjOhMomqHfXxXn/3GKTWlsQ== michael.j.schmidt@gmail.com

users:
  - name: michi
    groups:
      - sudo
      - docker
    ssh-authorized-keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAvFapuevZeHFpFn438XMjvEQYd0wt7+tzUdAkMiSd007Tx1h79Xm9ZziDDUe4W6meinVOq93MAS/ER27hoVWGo2H/vn/Cz5M8xr2j5rQODnrF3RmfrJTbZAWaDN0JTq2lFjmCHhZJNhr+VQP1uw4z2ofMBP6MLybnLmm9ukzxFYZqCCyfEEUTCMA9SWywtTpGQp8VLM4INCxzBSCuyt3SO6PBvJSo4HoKg/sLvmRwpCVZth48PI0EUbJ72wp88Cw3bv8CLce2TOkLMwkE6NRN55w2aOyqP1G3vixHa6YcVaLlkQhJoJsBwE3rX5603y2KjOhMomqHfXxXn/3GKTWlsQ== michael.j.schmidt@gmail.com

coreos:
  etcd2:
    name: core1
    initial-cluster: core0=http://192.168.2.2:2380,core1=http://192.168.2.3:2380,core2=http://192.168.2.4:2380
    advertise-client-urls: http://$public_ipv4:2379
    initial-advertise-peer-urls: http://$private_ipv4:2380
    listen-client-urls: http://0.0.0.0:2379,http://0.0.0.0:4001
    listen-peer-urls: http://$private_ipv4:2380
  units:
    - name: dhcp.network
      command: restart
      content: |
        [Match]
        Name=bond0

        [Network]
        DHCP=both
    - name: ethernet1.network
      command: restart
      content: |
        [Match]
        Name=enp2s0

        [Network]
        Bond=bond0
    - name: ethernet2.network
      command: restart
      content: |
        [Match]
        Name=enp3s0

        [Network]
        Bond=bond0
    - name: virtual.netdev
      command: restart
      content: |
        [NetDev]
        Name=bond0
        Kind=bond
    - name: etcd2.service
      command: start
    - name: fleet.service
      command: start
    - name: user-cloudinit@var-lib-coreos\x2dinstall-user_data.service
      content: |
        [Unit]
        After=coreos-setup-environment.service
        Requires=coreos-setup-environment.service
        After=network-online.target
        Wants=network-online.target
        Before=user-config.target
        ConditionFileNotEmpty=%f
        Description=Fetch Updated Userdata

        [Service]
        Type=oneshot
        RemainAfterExit=true
        EnvironmentFile=-/etc/environment
        ExecStartPre=/usr/bin/wget -O /var/lib/coreos-install/user_data https://raw.githubusercontent.com/BugRoger/d26a/master/cloudinit/core02
        ExecStart=/usr/bin/coreos-cloudinit --from-file=%f
    - name: bootstrap.service
      command: "start"
      content: |
        [Unit]
        Requires=docker.service
        After=docker.service

        [Service]
        Type=oneshot
        RemainAfterExit=false
        ExecStart=/usr/bin/bash -c "[ -d /var/lib/d26a ] || git clone https://github.com/bugroger/d26a /var/lib/d26a"
        ExecStart=/usr/bin/bash -c "cd /var/lib/d26a && git reset --hard && git pull origin master"
        ExecStart=/var/lib/d26a/bootstrap.sh

write_files:
  - path: /etc/environment
    permissions: 0644
    content: |
      COREOS_PUBLIC_IPV4=192.168.2.3
      COREOS_PRIVATE_IPV4=192.168.2.3
  - path: /etc/systemd/system/docker.service.d/limits.conf
    permissions: 0644
    content: |
      [Service]
      LimitNOFILE=4096
